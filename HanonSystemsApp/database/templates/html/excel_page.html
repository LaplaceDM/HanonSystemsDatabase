<!DOCTYPE html>
{% load render_table from django_tables2 %}
{% load bootstrap3 %}
{% load django_tables2 %}
{% bootstrap_css %}
{% load static %}

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Live Modify</title>

    <!-- 引入 Bootstrap 样式和 jQuery 库 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- 加载静态资源 -->
    <link rel="stylesheet" href="{% static 'database/hours_calculations.css' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'favicon logo.png' %}">
    
    <style>
        body {
            padding-top: 50px;
        }
        .menu {
            display: flex;
            align-items: center;
            position: fixed;
            width: 100%;
            top: 50px;
            z-index: 1;
        }
        .dropdown {
            display: inline-block;
            width: 22%;
            vertical-align: top;
            position: relative;
        }
        .account {
            display: inline-block;
            width: 10%;
            vertical-align: top;
        }
        .dropdown-label {
            background-color: #0089c4;
            color: white;
            padding: 5px;
            font-family: sans-serif;
            text-align: center;
        }
        .dropdown-content a {
            display: block;
            color: black;
            padding: 5px;
            text-decoration: none;
            font-family: sans-serif;
            background-color: white;
        }
        .dropdown-content {
            position: absolute;
            width: 100%;
            left: 0;
            display: none;
            z-index: 2;
        }
        .dropdown-content a:hover {
            background-color: #ddd;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
        .menu-space {
            height: 35px;
        }

        .filter, .add {
            border-style: solid;
            border-color: black;
            border-width: 2px;
        }

        .top-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 2;
            background-color: #1d3442;
            text-align: left;
            padding: 0;
            height: 50px;
        }
        .header-logo {
            height: 40px;
            width: auto;
            margin-right: 20px;
        }
        .header-title {
            color: white;
            font-size: 24px;
            font-weight: bold;
            line-height: 50px;
        }
    </style>
</head>
<body>

    <!-- 顶部导航栏 -->
    <div class="top-header">
        <a href="{% url 'menu' %}">
            <img src="{% static 'logo.png' %}" alt="Title Image" class="header-logo">
        </a>
        <span class="header-title">GVV Lab Business Process Management System</span>
    </div>

    <!-- 用户登录后的菜单栏 -->
    {% if user.is_authenticated %}
    <div class="menu-space"></div>
    <div class="menu">
        <div class="dropdown">
            <div class="dropdown-label">Daily Operations</div>
            <div class="dropdown-content">
                <a href="{% url 'test' %}">Tests</a>
                <a href="{% url 'dut' %}">DUTs</a>
                <a href="{% url 'Harness' %}">Harnesses</a>
            </div>
        </div>

        <div class="dropdown">
            <div class="dropdown-label">Program Information</div>
            <div class="dropdown-content">
                <a href="{% url 'product' %}">Products</a>
                <a href="{% url 'program' %}">Programs</a>
                <a href="{% url 'TestMap' %}">Test Maps</a>
            </div>
        </div>

        <div class="dropdown">
            <div class="dropdown-label">Equipment Information</div>
            <div class="dropdown-content">
                <a href="{% url 'Chamber' %}">Chambers</a>
                <a href="{% url 'Dar' %}">DARs</a>
                <a href="{% url 'cage' %}">Cages</a>
                <a href="{% url 'Laptop' %}">Laptops</a>
                <a href="{% url 'Fluid' %}">Test Fluids</a>
            </div>
        </div>

        <div class="dropdown">
            <div class="dropdown-label">Other</div>
            <div class="dropdown-content">
                <a href="{% url 'Lab' %}">Labs</a>
                <a href="{% url 'Technician' %}">Technicians</a>
                <a href="{% url 'TestType' %}">Add new test type</a>
                <a href="{% url 'hours calculations' %}">Program Hours Calculator</a>
                <a href="{% url 'excel_page' %}">Excel Live Modify</a>
            </div>
        </div>

        <div class="account">
            <a class="nav-link" href="{% url 'Logout' %}">Logout</a>
        </div>
    </div>

    <!-- Excel Modification Section -->
    <div class="container mt-5">
        <h2>Excel Live Modify</h2>

        <!-- 上传Excel文件的表单 -->
        <form id="uploadForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="mb-3">
                <label for="formFile" class="form-label">Upload Excel File</label>
                <input class="form-control" type="file" name="excel_file" id="formFile" required>
            </div>
            <button type="submit" class="btn btn-primary">Upload & Preview</button>
        </form>

        <!-- 显示上传的文件列表 -->
        <h3 class="mt-5">Uploaded Files</h3>
        <ul id="fileList">
            {% for file in excel_files %}
                <li>
                    <span>{{ file }}</span>
                    <!-- 下载按钮 -->
                    <a class="btn btn-primary btn-sm" href="{% url 'download_excel' file %}">Download</a>
                    <!-- 删除按钮 -->
                    <button class="btn btn-danger btn-sm delete-btn" data-filename="{{ file }}">Delete</button>
                    <!-- 编辑按钮 -->
                    <button class="btn btn-info btn-sm file-link" data-filename="{{ file }}">Edit</button>
                </li>
            {% endfor %}
        </ul>

        <!-- 工作表选择下拉菜单 -->
        <div id="sheet-selector" class="mt-3" style="display: none;">
            <label for="sheetSelect">选择工作表：</label>
            <select id="sheetSelect" class="form-select" style="width: auto; display: inline-block;">
                <!-- 选项将在加载文件后动态生成 -->
            </select>
        </div>

        <!-- 显示文件内容的表格 -->
        <h3 class="mt-5">Excel File Preview</h3>
        <form id="saveForm" method="POST">
            {% csrf_token %}
            <div id="table-container">
                <!-- 表格会在这里动态加载 -->
            </div>
            <input type="hidden" name="file_name" id="file_name">
            <input type="hidden" name="excel_data" id="excel_data">
            <input type="hidden" name="sheet_name" id="sheet_name">
            <button type="submit" class="btn btn-success mt-3">Save Changes</button>
        </form>

        <!-- 图表容器 -->
        <h3 class="mt-3">Chart Preview</h3>
        <div id="chart-container" class="mt-3">
            <!-- 图表会在这里动态加载 -->
        </div>

        <!-- 下载已保存的文件按钮容器 -->
        <div id="download-container" class="mt-3"></div>
    </div>

    {% else %}
    <div class="nav-item">
        <a class="nav-link" href="{% url 'Login' %}">Login</a>
    </div>
    {% endif %}

    <!-- JavaScript 部分 -->
    <script type="text/javascript">
        // 获取 CSRF 令牌的函数
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    // 判断这个 cookie 字符串是否以我们想要的名称开头
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');

        // 为 AJAX 请求设置 CSRF 令牌
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^GET|HEAD|OPTIONS|TRACE$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader('X-CSRFToken', csrftoken);
                }
            }
        });

        // 上传文件部分
        $('#uploadForm').on('submit', function(event) {
            event.preventDefault();
            var formData = new FormData(this);
            $.ajax({
                url: '{% url "upload_excel" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    alert(response.message);
                    location.reload();  // 重新加载页面以显示新上传的文件
                }
            });
        });

        // 点击编辑按钮加载文件内容
        $('.file-link').on('click', function(event) {
            event.preventDefault();
            var fileName = $(this).data('filename');
            $.ajax({
                url: '/database/get_excel_content/' + fileName,
                type: 'GET',
                success: function(response) {
                    var tableHtml = response.table_html.replace(/<td>/g, '<td contenteditable="true">');
                    $('#table-container').html(tableHtml);
                    $('#file_name').val(fileName);

                    loadSheetData(fileName);
                    // 显示工作表选择器
                    $('#sheet-selector').show();

                    // 清空之前的下载链接
                    $('#download-container').html('');
                },
                error: function(xhr, status, error) {
                    alert('Loading File Failed:' + xhr.responseText);
                }
            });
        });

        function loadSheetData(fileName, sheetName) {
            var url = '/database/get_excel_content/' + fileName;
            if (sheetName) {
                url += '?sheet_name=' + encodeURIComponent(sheetName);
            }
            $.ajax({
                url: url,
                type: 'GET',
                success: function(response) {
                    // 动态生成工作表选项
                    var sheetNames = response.sheet_names;
                    var currentSheet = response.current_sheet;
                    var sheetSelect = $('#sheetSelect');
                    sheetSelect.empty();
                    for (var i = 0; i < sheetNames.length; i++) {
                        var option = $('<option>', {
                            value: sheetNames[i],
                            text: sheetNames[i],
                            selected: sheetNames[i] === currentSheet
                        });
                        sheetSelect.append(option);
                    }
    
                    // 显示表格数据
                    var tableHtml = response.table_html.replace(/<td>/g, '<td contenteditable="true">');
                    $('#table-container').html(tableHtml);
                    $('#sheet_name').val(currentSheet);
    
                    // 显示图表
                    if (response.chart_base64) {
                        var imgHtml = '<img src="data:image/png;base64,' + response.chart_base64 + '" alt="Chart">';
                        $('#chart-container').html(imgHtml);
                    } else {
                        $('#chart-container').html('<p>无法生成图表</p>');
                    }
    
                    // 清空之前的下载链接
                    $('#download-container').html('');
                },
                error: function(xhr, status, error) {
                    alert('加载文件失败：' + xhr.responseText);
                }
            });
        }

        // 当选择不同的工作表时，重新加载数据
        $('#sheetSelect').on('change', function() {
            var fileName = $('#file_name').val();
            var sheetName = $(this).val();
            loadSheetData(fileName, sheetName);
        });

        // 保存修改后的表格
        $('#saveForm').on('submit', function(event) {
            event.preventDefault();
            var tableHtml = $('#table-container').html();
            $('#excel_data').val(tableHtml);

            $.ajax({
                url: '{% url "save_excel" %}',
                type: 'POST',
                data: $(this).serialize(),
                success: function(response) {
                    alert(response.message);
                    if (response.download_url) {
                        $('#download-container').html(`
                            <a class="btn btn-primary mt-3" href="${response.download_url}" download>Download Saved File</a>
                        `);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Save Unsucessful');
                }
            });
        });

        // 删除文件部分
        $('.delete-btn').on('click', function(event) {
            event.preventDefault();
            var fileName = $(this).data('filename');
            var confirmed = confirm('Are you sure to delete ' + fileName + ' ?');
            if (confirmed) {
                $.ajax({
                    url: '{% url "delete_excel" %}',
                    type: 'POST',
                    data: {
                        'file_name': fileName
                    },
                    success: function(response) {
                        alert(response.message);
                        location.reload();  // 删除成功后重新加载页面
                    },
                    error: function(xhr, status, error) {
                        alert('Delete Failed:' + xhr.responseText);
                    }
                });
            }
        });
    </script>

</body>
</html>
